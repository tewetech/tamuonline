<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Tamu Undangan Online</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ================================================= */
        /* === Variabel dan Gaya Dasar Tema (REVISI UKURAN KECIL & STABIL) === */
        /* ================================================= */
        :root {
            /* Warna Dasar (TIDAK BERUBAH) */
            --bg-primary: #f0f0f5; 
            --bg-card: rgba(255, 255, 255, 0.5); 
            --text-main: #333333; 
            --text-subtle: #666666; 
            --accent-1: #08978b; /* Primer/Simpan */
            --accent-2: #ff6932; /* Hapus */
            --accent-3: #08978B; /* Tab Aktif/Edit/Salin */
            --border-color: rgba(0, 0, 0, 0.1); 
            
            /* Dimensi DIREVISI MENJADI LEBIH KECIL DARI ASLI */
            --glass-br: 10px; /* Radius border dikurangi sedikit (dari 12px) */
            --font-size-base: 0.9rem; /* Ukuran font dasar sedikit lebih kecil (dari 1rem) */
            --padding-base: 0.8em; /* Padding dasar dikurangi sedikit */

            /* Shadow & Warna Aksi (TIDAK BERUBAH) */
            --shadow-light: rgba(0, 0, 0, 0.1);
            --color-delete: var(--accent-2); /* Warna Merah/Oranye untuk Hapus */
            --color-save: var(--accent-1); 
            --color-copy: var(--accent-3); 
            --color-edit: var(--accent-3); 
        }

        /* --- Gaya Umum untuk body --- */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-main);
            min-height: 100vh;
            padding: 1.5em; /* Padding body dikurangi (dari 2em) */
            font-size: var(--font-size-base); /* Ukuran font body disesuaikan */
        }
        
        /* --- Kontainer utama (Card-like container) --- */
        .glass-card {
            background: var(--bg-card);
            backdrop-filter: blur(8px) saturate(180%); 
            -webkit-backdrop-filter: blur(8px) saturate(180%);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px var(--shadow-light); 
            padding: 1.25em; /* Padding dikurangi (dari 1.5em) */
            border-radius: var(--glass-br);
        }

        /* --- Header dan Judul (DIREVISI UKURAN KECIL) --- */
        header h1 {
            font-size: 1.8rem; /* Ukuran H1 dikurangi (dari 2.5rem) */
            font-weight: 700;
            color: var(--accent-1); 
        }
        header p {
            color: var(--text-subtle);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem; /* Ukuran font sub-judul sangat kecil */
        }
        
        /* --- Tombol Aksi Utama (Save & Download) (DIREVISI UKURAN KECIL) --- */
        .btn-primary, .btn-download {
            background-color: var(--color-save); 
            color: white;
            font-weight: 600;
            border-radius: 6px; 
            padding: 0.6rem 1.25rem; /* Padding dikurangi */
            font-size: 0.9rem; /* Ukuran font lebih kecil */
            box-shadow: 0 2px 6px rgba(8, 151, 139, 0.3); 
        }
        .btn-primary:hover:not(:disabled), .btn-download:hover:not(:disabled) {
            background-color: #046c63; 
            transform: translateY(-1px);
        }
        
        /* === Gaya Tombol Hapus (untuk Modal Hapus) === */
        .btn-delete {
            background-color: var(--color-delete); 
            color: white;
            font-weight: 600;
            border-radius: 6px; 
            box-shadow: 0 2px 6px rgba(255, 105, 50, 0.3); 
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn-delete:hover:not(:disabled) {
            background-color: #e04a1f; /* Warna sedikit lebih gelap saat hover */
            transform: translateY(-1px);
        }

        /* --- Tombol Aksi Tabel (Edit/Salin/Hapus) --- */
        .btn-table-action {
            /* Membuat tombol lebih kecil dan merata */
            font-size: 0.8rem; 
            padding: 0.4rem; 
            width: 1.8rem; 
            height: 1.8rem; 
            border-radius: 4px; 
            color: white; 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s;
        }

        /* --- Input Field --- */
        input[type="text"] {
            border: 1px solid var(--border-color);
            border-radius: 6px; 
            padding: 0.6rem; 
            font-size: 0.9rem; 
        }
        
        /* --- Tabel Styling --- */
        .data-table thead th {
            font-size: 0.8rem; 
            padding: 0.6rem 0.8rem; 
        }
        .data-table tbody td {
            padding: 0.6rem 0.8rem; 
            font-size: 0.875rem; 
            vertical-align: middle; 
        }
        
        /* --- Gaya Scrollable Data --- */
        .scrollable-data {
            max-height: 350px; 
            overflow-y: auto; 
            border: 1px solid var(--border-color);
            border-radius: var(--glass-br);
        }

        /* --- Gaya Toggle Switch Status Undangan (REVISI PERBAIKAN GESER) --- */
        .toggle-switch {
            width: 85px; /* Lebar tombol utama */
            height: 28px; /* Tinggi tombol utama */
            position: relative;
            display: inline-block;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "BELUM";
            height: 20px; /* Tinggi tombol dalam */
            width: 38px; /* Lebar tombol dalam */
            left: 4px; 
            bottom: 4px; 
            background-color: #ff5733; 
            transition: .4s;
            border-radius: 20px;
            line-height: 20px;
            text-align: center;
            color: white;
            font-weight: 600;
            font-size: 8px; 
        }
        input:checked + .slider {
            background-color: #08978b; /* Warna latar belakang saat SUDAH */
        }
        input:checked + .slider:before {
            /* PERBAIKAN: Mengurangi nilai X dari 49px menjadi 45px agar tulisan 'SUDAH' rata tengah */
            transform: translateX(39px); 
            background-color: #046c63; /* Warna tombol dalam saat SUDAH */
            content: "SUDAH";
        }
        
        /* --- Modal Styling --- */
        .modal {
            transition: all 0.3s ease-out;
            opacity: 0;
            pointer-events: none;
            display: flex; 
        }
        .modal-open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 1.5em;
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
        }
        .modal-open .modal-content {
            transform: translateY(0);
        }

        /* --- Toast Styling (Notifikasi) --- */
        #toastModal {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            pointer-events: none;
        }
        .toast-content {
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-size: 0.9rem;
            color: white;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            opacity: 0;
            transform: translateY(20px);
        }
        .toast-show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-success { background-color: var(--accent-1); border-color: #046c63; }
        .toast-error { background-color: var(--accent-2); border-color: #E55A29; }
        .toast-info { background-color: var(--accent-3); border-color: #1e40af; }

        /* --- Gaya Tab Navigasi --- */
        .tab-button {
            padding: 0.5rem 1rem;
            font-weight: 600;
            border-radius: 6px; 
            color: var(--text-subtle);
            font-size: 0.9rem; 
            transition: all 0.2s ease;
        }
        .tab-button:hover { background-color: rgba(0, 0, 0, 0.05); }
        .tab-active {
            background-color: var(--accent-3); 
            color: white;
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.3);
        }

    </style>
</head>
<body class="min-h-screen">

    <div class="max-w-4xl mx-auto space-y-4 md:space-y-6">
        
        <header class="text-center pt-2 pb-1">
            <h1 class="font-extrabold mb-1">Data Tamu Undangan Online</h1>
            <p class="text-sm text-gray-600">Tamu Undangan Kami Chusnul - Tri 2025</p>
        </header>

        <div class="flex justify-center glass-card p-1 shadow-md border-b border-gray-200">
            <button 
                id="tabChusnul" 
                onclick="changeSheet('Tamu Chusnul')"
                class="tab-button tab-active">
                Tamu Chusnul
            </button>
            <button 
                id="tabTri" 
                onclick="changeSheet('Tamu Tri')"
                class="tab-button">
                Tamu Tri
            </button>
        </div>

        <div id="messageArea" class="hidden"></div> 

        <div class="glass-card">
            <h2 class="text-base font-semibold text-gray-800 mb-3" id="inputSectionTitle">Input Data Baru (Tamu Chusnul)</h2>
            <form id="dataForm" class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                <input
                    type="text"
                    id="inputNama"
                    placeholder="Masukkan Nama Lengkap"
                    required
                    class="flex-grow shadow-sm"
                >
                <button
                    type="submit"
                    id="saveButton"
                    class="btn-primary font-semibold shadow-md hover:shadow-lg transition duration-150 ease-in-out disabled:opacity-50 flex items-center justify-center"
                >
                    <span id="saveButtonText">Simpan Data</span>
                    <svg id="saveSpinner" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </form>
        </div>

        <div class="glass-card">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-3 space-y-2 md:space-y-0">
                <h2 class="text-base font-semibold text-gray-800" id="dataSectionTitle">Data Tersimpan (Tamu Chusnul)</h2>
                <button
                    onclick="downloadData()"
                    class="btn-download text-white font-semibold shadow-md transition duration-150 ease-in-out disabled:opacity-50"
                >
                    <i class="fas fa-download mr-1"></i> Unduh Data (.csv)
                </button>
            </div>
            
            <div id="loadingIndicator" class="text-center py-4 text-sm text-gray-500">
                <svg class="animate-spin h-6 w-6 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-1">Memuat data...</p>
            </div>

            <div class="overflow-x-auto scrollable-data shadow-inner bg-white bg-opacity-80">
                <table class="min-w-full data-table border-collapse" id="dataTable">
                    <thead>
                        <tr class="text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                            <th class="py-2 px-3 sticky top-0 z-10">No.</th>
                            <th class="py-2 px-3 sticky top-0 z-10">Nama</th>
                            <th class="py-2 px-3 text-center sticky top-0 z-10 w-32">Status</th> 
                            <th class="py-2 px-3 text-center sticky top-0 z-10 w-32">Aksi</th> 
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
            
            <p id="noDataMessage" class="hidden text-center py-3 text-gray-500 text-sm">Belum ada data yang tersimpan.</p>
        </div>
    </div>

    <div id="editModal" class="modal modal-closed fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 p-3">
        <div class="modal-content p-4 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-3">Edit Data Nama</h3>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="mb-3">
                    <label for="editNama" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                    <input
                        type="text"
                        id="editNama"
                        required
                        class="w-full shadow-sm text-sm"
                    >
                </div>
                <div class="flex justify-end space-x-2">
                    <button
                        type="button"
                        onclick="closeEditModal()"
                        class="bg-gray-200 text-gray-700 font-semibold py-1.5 px-3 rounded-lg text-sm hover:bg-gray-300 transition duration-150"
                    >
                        Batal
                    </button>
                    <button
                        type="submit"
                        id="updateButton"
                        class="btn-primary text-white font-semibold py-1.5 px-3 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out disabled:opacity-50 text-sm"
                    >
                        Simpan Perubahan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="modal modal-closed fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 p-3">
        <div class="modal-content p-4 w-full max-w-xs">
            <h3 class="text-lg font-bold mb-3 text-gray-800"><i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i> Konfirmasi Hapus</h3>
            <p id="confirmMessage" class="mb-4 text-gray-700 text-sm">Apakah Anda yakin ingin menghapus data ini? Aksi ini tidak dapat dibatalkan.</p>
            
            <div class="flex justify-end space-x-2">
                <button
                    type="button"
                    onclick="closeConfirmModal(false)"
                    class="bg-gray-200 text-gray-700 font-semibold py-1.5 px-3 rounded-lg text-sm hover:bg-gray-300 transition duration-150"
                >
                    Batal
                </button>
                <button
                    type="button"
                    id="confirmDeleteButton"
                    class="btn-delete text-white font-semibold py-1.5 px-3 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out text-sm"
                >
                    <i class="fas fa-trash-alt mr-1"></i> Ya, Hapus
                </button>
            </div>
        </div>
    </div>
    
    <div id="toastModal" class="fixed">
        <div id="toastContent" class="toast-content text-center shadow-lg border-2">
            </div>
    </div>
    
    <script>
        // ====================================================================
        // KONFIGURASI PENTING (DIJAGA AGAR TIDAK BERUBAH FUNGSI)
        // ====================================================================
        // URL Apps Script Anda yang sebenarnya. HARUS DIGANTI!
        const GS_URL = 'https://script.google.com/macros/s/AKfycbwaj2IYLRwGxjXuqf-TFyUWag57jrC9UTQewozzvikAVTnrVc41aTLmjA0PY4uk9G1e/exec';
        
        // Nama Sheet/Kategori 
        const SHEET_CHUSNUL = 'Tamu Chusnul';
        const SHEET_TRI = 'Tamu Tri';
        
        // Variabel global untuk menentukan sheet/kategori yang aktif
        let currentSheet = SHEET_CHUSNUL;
        
        // BASE URL UNDANGAN 
        const BASE_INVITATION_URL = 'https://tewetech.github.io/wedding-of-chusnul-tri/';
        
        // Variabel untuk menyimpan fungsi callback hapus 
        let deleteCallback = null;
        
        // ====================================================================
        
        // Elemen DOM yang digunakan
        const dataForm = document.getElementById('dataForm');
        const inputNama = document.getElementById('inputNama');
        const tableBody = document.getElementById('tableBody');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const noDataMessage = document.getElementById('noDataMessage');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const editId = document.getElementById('editId');
        const editNama = document.getElementById('editNama');
        const saveButton = document.getElementById('saveButton');
        const saveButtonText = document.getElementById('saveButtonText');
        const saveSpinner = document.getElementById('saveSpinner');
        const inputSectionTitle = document.getElementById('inputSectionTitle');
        const dataSectionTitle = document.getElementById('dataSectionTitle');
        const tabChusnul = document.getElementById('tabChusnul');
        const tabTri = document.getElementById('tabTri');
        
        // Elemen DOM untuk Toast/Notifikasi
        const toastModal = document.getElementById('toastModal');
        const toastContent = document.getElementById('toastContent');
        
        // Elemen DOM untuk Modal Konfirmasi Hapus
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');

        // Variabel global untuk menyimpan data yang sedang aktif
        let currentData = [];

        // --------------------------------------------------------------------
        // FUNGSI UTILITY (PEMBANTU)
        // --------------------------------------------------------------------

        /**
         * Menampilkan pesan notifikasi kecil (toast/popup) di tengah layar.
         * @param {string} message Pesan yang akan ditampilkan.
         * @param {('success'|'error'|'info')} type Tipe pesan.
         */
        function showToast(message, type) {
            let icon = '';
            let colorClass = '';
            if (type === 'success') {
                icon = '<i class="fas fa-check-circle mr-2"></i>';
                colorClass = 'toast-success';
            } else if (type === 'error') {
                icon = '<i class="fas fa-times-circle mr-2"></i>';
                colorClass = 'toast-error';
            } else if (type === 'info') { 
                icon = '<i class="fas fa-info-circle mr-2"></i>';
                colorClass = 'toast-info';
            }
            
            toastContent.innerHTML = `${icon}${message}`;
            toastContent.className = `toast-content ${colorClass}`;
            
            // Tampilkan toast dengan animasi
            setTimeout(() => {
                toastContent.classList.add('toast-show');
            }, 50); 

            // Hilangkan toast setelah 4 detik
            setTimeout(() => {
                toastContent.classList.remove('toast-show');
                setTimeout(() => {
                    toastContent.className = 'toast-content';
                }, 300); 
            }, 4000); 
        }

        /**
         * Mengatur status tombol Simpan saat memproses data.
         * @param {boolean} isLoading Status memuat.
         * @param {string} text Teks tombol.
         */
        function setSaveLoading(isLoading, text = 'Simpan Data') {
            saveButton.disabled = isLoading;
            saveButtonText.textContent = text;
            if (isLoading) {
                saveButtonText.classList.add('hidden');
                saveSpinner.classList.remove('hidden');
            } else {
                saveButtonText.classList.remove('hidden');
                saveSpinner.classList.add('hidden');
            }
        }

        /**
         * Format timestamp menjadi format yang mudah dibaca.
         * @param {string} timestamp Timestamp string dari Sheets.
         * @returns {string} Timestamp yang diformat.
         */
        function formatTimestamp(timestamp) {
            try {
                const date = new Date(timestamp);
                if (isNaN(date)) return timestamp; 
                
                return date.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return timestamp; 
            }
        }
        
        // --------------------------------------------------------------------
        // FUNGSI UNTUK MEMBUAT TEKS UNDANGAN
        // --------------------------------------------------------------------
        
        /**
         * Membuat teks undangan lengkap untuk disalin.
         * @param {string} namaTamu Nama tamu.
         * @returns {string} Teks undangan lengkap.
         */
        function createInvitationText(namaTamu) {
            const encodedNama = encodeURIComponent(namaTamu.trim());
            const invitationLink = `${BASE_INVITATION_URL}?to=${encodedNama}`;

            const text = 
`_*Assalamualaikum Warahmatullahi Wabarakatuh*_
Kepada Yth. 

*${namaTamu.trim()}*

Tanpa mengurangi rasa hormat, perkenankan kami mengundang Bapak/Ibu/Saudara/i untuk menghadiri acara kami.
Berikut link undangan kami, untuk info lengkap bisa kunjungi :

${invitationLink}

Merupakan suatu kebahagiaan bagi kami, apabila Bapak/Ibu/Saudara/i berkenan untuk hadir dan memberikan doa restu.

Mohon maaf perihal undangan hanya di bagikan melalui pesan ini.
Terima kasih banyak atas perhatiannya.
_*Wassalamualaikum Warahmatullahi Wabarakatuh*_

Hormat kami,
*_Chusnul & Tri_*

*Keluarga yang Berbahagia :*
Bpk. Sularto & Ibu Sri Mulyani, S.Pd.SD
_(Orang Tua Mempelai Putri)_

Bpk. Sudi Karyono & Ibu Ngasirah
_(Orang Tua Mempelai Putra)_`;

            return text;
        }

        // --------------------------------------------------------------------
        // FUNGSI UNTUK MENYALIN TEKS KE CLIPBOARD
        // --------------------------------------------------------------------
        
        /**
         * Menyalin teks undangan ke clipboard.
         * @param {string} namaTamu Nama tamu yang akan disalin.
         */
        window.copyInvitation = async (namaTamu) => {
            const invitationText = createInvitationText(namaTamu);
            
            try {
                await navigator.clipboard.writeText(invitationText);
                showToast(`Teks undangan untuk "${namaTamu}" berhasil disalin!`, 'info');
            } catch (err) {
                console.error('Gagal menyalin teks:', err);
                showToast('Gagal menyalin teks. Silakan salin teks secara manual.', 'error');
                prompt("Gagal menyalin otomatis, silakan salin teks di bawah ini secara manual:", invitationText);
            }
        }

        // --------------------------------------------------------------------
        // FUNGSI PENGATUR KATEGORI (SHEET)
        // --------------------------------------------------------------------

        /**
         * Mengubah sheet/kategori yang aktif dan memuat ulang data.
         * @param {string} sheetName Nama sheet baru yang akan digunakan.
         */
        window.changeSheet = (sheetName) => {
            if (currentSheet === sheetName) return; 

            currentSheet = sheetName;
            
            // Perbarui tampilan tab aktif
            tabChusnul.classList.remove('tab-active');
            tabTri.classList.remove('tab-active');
            if (sheetName === SHEET_CHUSNUL) {
                tabChusnul.classList.add('tab-active');
            } else if (sheetName === SHEET_TRI) {
                tabTri.classList.add('tab-active');
            }

            // Perbarui judul
            inputSectionTitle.textContent = `Input Data Baru (${currentSheet})`;
            dataSectionTitle.textContent = `Data Tersimpan (${currentSheet})`;

            // Muat ulang data 
            fetchData();
        }

        // --------------------------------------------------------------------
        // FUNGSI UTAMA INTERAKSI DENGAN APPS SCRIPT
        // --------------------------------------------------------------------

        /**
         * Mengirim permintaan POST ke Google Apps Script.
         * @param {object} data Payload data untuk Apps Script.
         * @returns {Promise<object>} Respon dari Apps Script.
         */
        async function postToGS(data) {
            data.sheet = currentSheet;

            // Pengecekan URL (HANYA CONTOH URL, HARAP GANTI)
            if (GS_URL.includes('AKfycbw2fROAOY_OEzuNH1FvuuG2xDc1H20AUN781LbjSOGXz6B1qLTPVnkCrl_81xZ_FYM1/exec') && !confirm("ANDA MASIH MENGGUNAKAN URL CONTOH. Lanjutkan?")) { 
                loadingIndicator.classList.add('hidden');
                noDataMessage.textContent = 'Harap ganti GS_URL di skrip JavaScript dengan URL Apps Script Anda.';
                noDataMessage.classList.remove('hidden');
                throw new Error("Invalid GS_URL");
            }

            try {
                const response = await fetch(GS_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(data) 
                });

                if (!response.ok) {
                    throw new Error(`Jaringan bermasalah, status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.status === 'ERROR') {
                    throw new Error(result.message || 'Operasi gagal di sisi Apps Script.');
                }
                
                return result;

            } catch (error) {
                console.error('Fetch Error:', error);
                throw new Error(`Gagal terhubung ke server: ${error.message}`);
            }
        }

        /**
         * Mengambil semua data dari Google Spreadsheet.
         */
        async function fetchData() {
            loadingIndicator.classList.remove('hidden');
            tableBody.innerHTML = '';
            noDataMessage.classList.add('hidden');

            try {
                const url = `${GS_URL}?action=READ&sheet=${encodeURIComponent(currentSheet)}`;
                const response = await fetch(url, { method: 'GET' });
                
                if (!response.ok) throw new Error(`Gagal mengambil data, status: ${response.status}`);
                
                const result = await response.json();
                currentData = Array.isArray(result.data) ? result.data : [];
                renderTable(currentData);
                
            } catch (error) {
                console.error('Fetch Data Error:', error);
                showToast(`Gagal memuat data: ${error.message}`, 'error');
                loadingIndicator.classList.add('hidden');
            }
        }

        // --------------------------------------------------------------------
        // FUNGSI UNTUK MERENDER DATA DAN INTERAKSI UI
        // --------------------------------------------------------------------

        /**
         * Merender array data ke dalam tabel HTML. 
         */
        function renderTable(data) {
            loadingIndicator.classList.add('hidden');
            tableBody.innerHTML = ''; 
            
            if (data.length === 0) {
                noDataMessage.classList.remove('hidden');
                noDataMessage.textContent = `Belum ada data yang tersimpan di sheet: ${currentSheet}.`;
                return;
            }

            noDataMessage.classList.add('hidden');
            
            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.classList.add('hover:bg-gray-50', 'transition', 'duration-100');
                
                // Ambil data: [Timestamp (dilewati), ID, Nama, Status]
                const id = row[1];
                const nama = row[2];
                const status = row[3] || 'BELUM'; 
                
                const isChecked = status.toUpperCase() === 'SUDAH';
                const checkedAttribute = isChecked ? 'checked' : '';

                // Escape karakter kutipan tunggal
                const escapedNama = nama.replace(/'/g, "\\'"); 

                tr.innerHTML = `
                    <td class="py-2 px-3 whitespace-nowrap">${index + 1}</td>
                    <td class="py-2 px-3 font-medium text-gray-900">${nama}</td>
                    
                    <td class="py-2 px-3 text-center">
                        <div class="flex justify-center items-center h-full">
                            <label class="toggle-switch">
                                <input 
                                    type="checkbox" 
                                    ${checkedAttribute} 
                                    onclick="updateInvitationStatus('${id}', this.checked, '${escapedNama}')"
                                >
                                <span class="slider"></span>
                            </label>
                        </div>
                    </td>

                    <td class="py-2 px-3 whitespace-nowrap text-center">
                        <div class="flex justify-center items-center space-x-1">
                            <button onclick="openEditModal('${id}', '${escapedNama}')" class="btn-table-action bg-blue-500 hover:bg-blue-700" title="Edit Nama">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="copyInvitation('${escapedNama}')" class="btn-table-action bg-green-500 hover:bg-green-700" title="Salin Undangan">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="openConfirmDelete('${id}', '${escapedNama}')" class="btn-table-action bg-red-500 hover:bg-red-700" title="Hapus Data">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }
        
        // --------------------------------------------------------------------
        // HANDLER EVENT FORM SUBMISSION (SIMPAN BARU)
        // --------------------------------------------------------------------

        dataForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nama = inputNama.value.trim();

            if (!nama) {
                showToast('Nama tidak boleh kosong.', 'error');
                return;
            }

            setSaveLoading(true, 'Menyimpan...');

            try {
                const data = {
                    action: 'SAVE',
                    nama: nama,
                    status: 'BELUM' 
                };
                
                await postToGS(data);
                
                showToast(`Data "${nama}" berhasil disimpan di ${currentSheet}!`, 'success');
                inputNama.value = ''; 
                fetchData(); 

            } catch (error) {
                showToast(`Gagal menyimpan data: ${error.message}`, 'error');
            } finally {
                setSaveLoading(false, 'Simpan Data');
            }
        });


        // --------------------------------------------------------------------
        // FUNGSI EDIT DAN HAPUS DATA
        // --------------------------------------------------------------------

        /**
         * Membuka modal edit data.
         * @param {string} id ID unik data.
         * @param {string} nama Nama saat ini.
         */
        window.openEditModal = (id, nama) => {
            editId.value = id;
            editNama.value = nama;
            editModal.classList.remove('modal-closed');
            editModal.classList.add('modal-open');
        }

        /**
         * Menutup modal edit data.
         */
        window.closeEditModal = () => {
            editModal.classList.remove('modal-open');
            editModal.classList.add('modal-closed');
        }

        /**
         * Handler form submit untuk update data.
         */
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = editId.value;
            const newNama = editNama.value.trim();

            if (!newNama || !id) {
                showToast('Nama atau ID tidak valid.', 'error');
                return;
            }

            const updateButton = document.getElementById('updateButton');
            updateButton.disabled = true;
            updateButton.textContent = 'Memperbarui...';

            try {
                const data = {
                    action: 'UPDATE', 
                    id: id,
                    nama: newNama
                };

                await postToGS(data);
                
                showToast(`Data ID ${id.substring(0, 5)}... berhasil diperbarui di ${currentSheet} menjadi "${newNama}".`, 'success');
                closeEditModal();
                fetchData(); 

            } catch (error) {
                showToast(`Gagal memperbarui data: ${error.message}`, 'error');
            } finally {
                updateButton.disabled = false;
                updateButton.textContent = 'Simpan Perubahan';
            }
        });
        
        /**
         * Membuka modal konfirmasi hapus.
         * @param {string} id ID unik data.
         * @param {string} nama Nama yang akan dihapus.
         */
        window.openConfirmDelete = (id, nama) => {
            confirmMessage.innerHTML = `Apakah Anda yakin ingin menghapus data untuk <strong>"${nama}"</strong> (di ${currentSheet})? Aksi ini tidak dapat dibatalkan.`;
            
            deleteCallback = () => executeDeleteData(id, nama);
            
            confirmModal.classList.remove('modal-closed');
            confirmModal.classList.add('modal-open');
        }
        
        /**
         * Menutup modal konfirmasi hapus dan memicu callback (jika dikonfirmasi).
         * @param {boolean} isConfirmed Status konfirmasi dari tombol.
         */
        window.closeConfirmModal = (isConfirmed) => {
            confirmModal.classList.remove('modal-open');
            confirmModal.classList.add('modal-closed');

            if (isConfirmed && deleteCallback) {
                deleteCallback(); 
            } else if (!isConfirmed) {
                showToast('Penghapusan dibatalkan.', 'info');
            }
            deleteCallback = null; 
        }
        
        confirmDeleteButton.addEventListener('click', () => {
            // Memicu penutupan modal dengan status terkonfirmasi (true)
            closeConfirmModal(true);
        });

        /**
         * Fungsi yang menjalankan proses penghapusan data sebenarnya.
         */
        async function executeDeleteData(id, nama) {
            try {
                const data = {
                    action: 'DELETE',
                    id: id
                };

                loadingIndicator.classList.remove('hidden');

                await postToGS(data);
                
                showToast(`Data "${nama}" berhasil dihapus dari ${currentSheet}.`, 'success');
                fetchData(); 

            } catch (error) {
                showToast(`Gagal menghapus data: ${error.message}`, 'error');
            } 
        }
        
        /**
         * Memperbarui status undangan tamu di Google Sheet.
         * @param {string} id ID unik data.
         * @param {boolean} isChecked Status saklar (true = SUDAH, false = BELUM).
         * @param {string} nama Nama tamu.
         */
        window.updateInvitationStatus = async (id, isChecked, nama) => {
            const newStatus = isChecked ? 'SUDAH' : 'BELUM';
            
            try {
                const data = {
                    action: 'UPDATE_STATUS', 
                    id: id,
                    status: newStatus
                };

                await postToGS(data);
                
                showToast(`Status undangan untuk "${nama}" berhasil diperbarui menjadi *${newStatus}*.`, 'success');
                
                const indexToUpdate = currentData.findIndex(row => row[1] === id); 
                if (indexToUpdate !== -1) {
                    // Update data lokal agar tabel tidak perlu di-render ulang sepenuhnya
                    currentData[indexToUpdate][3] = newStatus;
                }

            } catch (error) {
                showToast(`Gagal memperbarui status: ${error.message}`, 'error');
                // Kembalikan posisi saklar jika gagal
                document.querySelector(`input[onclick*="${id}"]`).checked = !isChecked;
            }
        }

        // --------------------------------------------------------------------
        // FUNGSI UNDUH DATA
        // --------------------------------------------------------------------

        /**
         * Mengunduh data yang saat ini ada di tabel ke dalam format CSV.
         */
        window.downloadData = () => {
            if (currentData.length === 0) {
                showToast(`Tidak ada data di ${currentSheet} untuk diunduh.`, 'error');
                return;
            }

            let csv = "No.,Timestamp,Nama,Status Undangan\n";

            currentData.forEach((row, index) => {
                // Ambil elemen data yang diperlukan
                const [timestamp, , nama, status = 'BELUM'] = row; 
                const formattedTimestamp = formatTimestamp(timestamp).replace(/,/g, ''); 
                csv += `${index + 1},"${formattedTimestamp}","${nama.replace(/"/g, '""')}","${status}"\n`;
            });

            // Buat file CSV dan unduh
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `data_tamu_${currentSheet.toLowerCase().replace(/\s/g, '_')}_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Data berhasil diunduh dalam format CSV.', 'success');
        }

        // --------------------------------------------------------------------
        // INISIALISASI
        // --------------------------------------------------------------------

        // Panggil fetchData saat dokumen selesai dimuat 
        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>

</html>
